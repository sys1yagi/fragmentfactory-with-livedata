package com.sys1yagi.fragmentfactorywithlivedata.searchbook

import androidx.lifecycle.*
import kotlinx.coroutines.*

class BookSearchViewModel : ViewModel() {

    enum class ViewState {
        PROGRESS,
        NOT_PROGRESS
    }

    private val viewState = MutableLiveData<ViewState>()
    fun viewState(): LiveData<ViewState> = viewState

    fun searchBook(source: LiveData<String>): LiveData<Result<List<String>?>> {
        var job = Job()
        var current = ""
        return Transformations.switchMap(source) { keyword ->
            val result = MutableLiveData<Result<List<String>?>>()
            job.cancel()
            if (current != keyword) {
                viewState.postValue(ViewState.PROGRESS)
                current = keyword
                job = viewModelScope.launch {
                    try {
                        val results = randomResult()
                        result.postValue(Result.success(results ?: emptyList()))
                        viewState.postValue(ViewState.NOT_PROGRESS)
                    } catch (e: CancellationException) {
                        // no op
                    } catch (e: Exception) {
                        result.postValue(Result.failure(e))
                        viewState.postValue(ViewState.NOT_PROGRESS)
                    }
                }
            } else {
                viewState.postValue(ViewState.NOT_PROGRESS)
                result.postValue(Result.success(null))
            }
            result
        }
    }

    private suspend fun randomResult() = withContext(Dispatchers.IO) {
        delay(2000)
        listOf(
            "愛読書の印象",
            "秋",
            "芥川竜之介歌集",
            "アグニの神",
            "アグニの神",
            "悪魔",
            "浅草公園　或シナリ",
            "兄貴のような心持　――菊池寛氏の印象―",
            "あの頃の自分の事",
            "あばばばば",
            "鴉片",
            "或阿呆の一生",
            "或敵打の話",
            "或旧友へ送る手記",
            "或社会主義者",
            "或日の大石内蔵助",
            "或恋愛小説",
            "闇中問答",
            "案頭の書",
            "飯田蛇笏",
            "遺書",
            "イズムと云ふ語の意味次第",
            "一番気乗のする時",
            "一夕話",
            "伊東から",
            "糸女覚え書",
            "犬養君に就いて",
            "犬と笛",
            "芋粥",
            "岩野泡鳴氏",
            "魚河岸",
            "内田百間氏",
            "産屋　萩原朔太郎君に献",
            "馬の脚",
            "海のほとり",
            "囈語",
            "運",
            "永久に不愉快な二重生活",
            "英雄の器",
            "江口渙氏の事",
            "槐",
            "老いたる素戔嗚尊",
            "往生絵巻",
            "鸚鵡　――大震覚え書の一つ―",
            "大川の水",
            "大久保湖州",
            "Ｏ君の新秋",
            "尾形了斎覚え書",
            "おぎん",
            "お時儀",
            "おしの",
            "お富の貞操",
            "鬼ごつこ",
            "お律と子等と",
            "温泉だより",
            "女",
            "開化の良人",
            "開化の殺人",
            "貝殻",
            "解嘲",
            "蛙",
            "格さんと食慾　――最近の宇野浩二氏―",
            "影",
            "片恋",
            "かちかち山",
            "学校友だち",
            "河童",
            "河童",
            "南瓜",
            "神神の微笑",
            "「仮面」の人々",
            "鴨猟",
            "軽井沢で",
            "カルメン",
            "彼",
            "彼　第二",
            "枯野抄",
            "彼の長所十八　――南部修太郎氏の印象―",
            "寒山拾得",
            "鑑定",
            "奇怪な再会",
            "機関車を見ながら",
            "奇遇",
            "「菊池寛全集」の序",
            "煙管",
            "木曽義仲論",
            "着物",
            "凶",
            "「鏡花全集」目録開口",
            "教訓談",
            "京都日記",
            "きりしとほろ上人伝",
            "疑惑",
            "金将軍",
            "鵠沼雑記",
            "孔雀",
            "首が落ちた話",
            "久保田万太郎氏",
            "久米正雄　――傚久米正雄文体―",
            "久米正雄氏の事",
            "蜘蛛の糸",
            "クラリモンド",
            "軍艦金剛航海記",
            "芸術その他",
            "戯作三昧",
            "戯作三昧",
            "袈裟と盛遠",
            "結婚難並びに恋愛難",
            "「ケルトの薄明」より",
            "玄鶴山房",
            "講演軍記",
            "剛才人と柔才人と",
            "好色",
            "後世",
            "校正後に",
            "合理的、同時に多量の人間味　――相互印象・菊池寛氏―",
            "黄粱夢",
            "黒衣聖母",
            "小杉未醒氏",
            "古千屋",
            "骨董羹　―寿陵余子の仮名のもとに筆を執れる戯文",
            "孤独地獄",
            "子供の病気　一游亭",
            "湖南の扇",
            "近藤浩一路氏",
            "金春会の「隅田川」",
            "西郷隆盛",
            "才一巧亦不二",
            "西方の人",
            "鷺と鴛鴦",
            "雑信一束",
            "雑筆",
            "佐藤春夫氏",
            "佐藤春夫氏の事",
            "さまよえる猶太人",
            "寒さ",
            "沙羅の花",
            "猿",
            "猿蟹合戦",
            "三右衛門の罪",
            "死後",
            "地獄変",
            "地獄変",
            "詩集",
            "十本の針",
            "支那の画",
            "「支那游記」自序",
            "島木赤彦氏",
            "耳目記",
            "霜夜",
            "邪宗門",
            "上海游記",
            "十円札",
            "秋山図",
            "蒐書",
            "侏儒の言葉",
            "侏儒の言葉",
            "「侏儒の言葉」の序",
            "酒虫",
            "出帆",
            "じゅりあの・吉助",
            "俊寛",
            "将軍",
            "商賈聖母",
            "饒舌",
            "小説作法十則",
            "小説の戯曲化",
            "小説の読者",
            "少年",
            "娼婦美と冒険",
            "食物として",
            "虱",
            "しるこ",
            "白",
            "蜃気楼",
            "新緑の庭",
            "塵労",
            "素戔嗚尊",
            "捨児",
            "青年と死",
            "西洋画のやうな日本画",
            "仙人",
            "仙人",
            "仙人",
            "葬儀記",
            "創作",
            "早春",
            "漱石山房の秋",
            "漱石山房の冬",
            "装幀に就いての私の意見",
            "続西方の人",
            "続澄江堂雑記",
            "続芭蕉雑記",
            "続文芸的な、余りに文芸的な",
            "続野人生計事",
            "その頃の赤門生活",
            "素描三題",
            "大正十二年九月一日の大震に際して",
            "大導寺信輔の半生　――或精神的風景画―",
            "大導寺信輔の半生　―或精神的風景画",
            "第四の夫から",
            "滝田哲太郎君",
            "滝田哲太郎氏",
            "竜村平蔵氏の芸術",
            "谷崎潤一郎氏",
            "たね子の憂鬱",
            "煙草と悪魔",
            "田端人",
            "田端日記",
            "近頃の幽霊",
            "父",
            "忠義",
            "偸盗",
            "澄江堂雑記",
            "長江游記",
            "樗牛の事",
            "追憶",
            "恒藤恭氏",
            "手紙",
            "出来上った人　――室生犀星氏―",
            "伝吉の敵打ち",
            "点鬼簿",
            "点心",
            "東京小品",
            "東京に生れて",
            "東西問答",
            "道祖問答",
            "動物園",
            "東洋の秋",
            "都会で",
            "杜子春",
            "杜子春",
            "豊島与志雄氏の事",
            "虎の話",
            "トロッコ",
            "トロツコ",
            "長崎",
            "長崎小品",
            "夏目先生と滝田さん",
            "南京の基督",
            "廿年後之戦争",
            "偽者二題",
            "尼提",
            "日光小品",
            "日本小説の支那訳",
            "日本の女",
            "入社の辞",
            "女仙",
            "女体",
            "庭",
            "沼",
            "沼地",
            "葱",
            "鼠小僧次郎吉",
            "念仁波念遠入礼帖",
            "年末の一日",
            "野呂松人形",
            "八宝飯",
            "俳画展覧会を観て",
            "梅花に対する感情　このジャアナリズムの一篇を謹厳なる西川英次郎君に献",
            "売文問答",
            "歯車",
            "歯車",
            "芭蕉雑記",
            "パステルの竜",
            "はつきりした形をとる為めに",
            "鼻",
            "母",
            "春",
            "バルタザアル",
            "春の心臓",
            "春の日のさした往来をぶらぶら一人歩いてゐる",
            "春の夜は",
            "春の夜",
            "手巾",
            "ピアノ",
            "微笑",
            "尾生の信",
            "人及び芸術家としての薄田泣菫氏　薄田泣菫氏及び同令夫人に献",
            "一塊の土",
            "一つの作が出来上るまで　――「枯野抄」――「奉教人の死」―",
            "一人の無名作家",
            "雛",
            "病牀雑記",
            "病中雑記",
            "ひょっとこ",
            "平田先生の翻訳",
            "比呂志との問答",
            "風変りな作品に就いて",
            "不思議な島",
            "拊掌談",
            "二つの手紙",
            "二人小町",
            "二人の友",
            "舞踏会",
            "文放古",
            "冬",
            "仏蘭西文学と僕",
            "プロレタリア文学論",
            "文学好きの家庭から",
            "文芸鑑賞講座",
            "文芸的な、余りに文芸的な",
            "文章",
            "文章と言葉と",
            "僻見",
            "北京日記抄",
            "変遷その他",
            "報恩記",
            "奉教人の死",
            "ポーの片影",
            "僕の友だち二三人",
            "僕は",
            "発句私見",
            "本所両国",
            "本所両国",
            "本の事",
            "翻訳小品",
            "正岡子規",
            "魔術",
            "又一説？",
            "亦一説？",
            "松江印象記",
            "窓",
            "蜜柑",
            "蜜柑",
            "蜜柑",
            "水の三日",
            "三つの宝",
            "三つのなぜ",
            "三つの窓",
            "三つの指環",
            "身のまはり",
            "妙な話",
            "貉",
            "無題",
            "Mensura Zoili",
            "毛利先生",
            "桃太郎",
            "森先生",
            "文部省の仮名遣改定案について",
            "野人生計事",
            "保吉の手帳から",
            "藪の中",
            "藪の中",
            "山鴫",
            "槍ヶ岳紀行",
            "槍が岳に登った記",
            "悠々荘",
            "誘惑",
            "雪",
            "夢",
            "夢",
            "百合",
            "妖婆",
            "横須賀小景",
            "世之助の話",
            "世の中と女",
            "羅生門",
            "羅生門",
            "羅生門の後に",
            "リチャード・バートン訳「一千一夜物語」に就いて",
            "竜",
            "るしへる",
            "恋愛と夫婦愛とを混同しては不可ぬ",
            "老年",
            "臘梅",
            "六の宮の姫君",
            "路上",
            "LOS CAPRICHOS",
            "露訳短篇集の序",
            "わが散文詩",
            "わが俳諧修業",
            "わが家の古玩",
            "忘れられぬ印象",
            "私の好きなロマンス中の女性"
        ).shuffled().take(20)
    }

}
